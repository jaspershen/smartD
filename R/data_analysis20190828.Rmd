---
title: "Data analysis for smartD project RPLC data sets"
output:
  html_document:
    df_print: paged
---

```{r setup}
knitr::opts_chunk$set(root.dir = "E:/project/smartD/data_analysis20190828")
knitr::opts_knit$set(root.dir = 'E:/project/smartD/data_analysis20190828')
```

> Note: Only use RPLC data

### PCA analysis to check the data quality

load dataset

```{r, eval=TRUE, echo=TRUE}
load("smartd_rplc_neg_batch1_5")
load("smartd_rplc_pos_batch1_5")
load("smartd_rplc_neg_batch2_5")
load("smartd_rplc_pos_batch2_5")
```

Let us see if the samples distrubite in PCA score plot.

#### RPLC pos batch 1

```{r, eval=TRUE, echo=TRUE}
library(metflow2)
library(ggplot2)
library(tidyverse)

sample.info <- 
  smartd_rplc_pos_batch1_5@sample.info

subject_data <- 
  getData(object = smartd_rplc_pos_batch1_5, slot = "Subject")

sample.info <- 
  sample.info %>% 
  filter(GA != 0)

subject_data <- 
  subject_data %>% 
  select(one_of(sample.info$sample.name))

##auto scale
subject_data <- 
  t(
    apply(subject_data, 1, function(x){
      (x - mean(x))/sd(x)
    })
  ) %>% 
  as_tibble()

subject_data2 <- t(subject_data)
subject_data2 <- as_tibble(subject_data2)
# rownames(subject_data2)

subject_data2 <- 
  subject_data2 %>% 
  mutate(GA = sample.info$GA)

##PCA analysis
pca_object <- 
  prcomp(x = select(subject_data2, -GA))

library(ggfortify)
x <- pca_object$x
x <- x[,1:2]
x <- 
  data.frame(x, GA = subject_data2$GA, stringsAsFactors = FALSE)
x <- data.frame(x, name = colnames(subject_data), 
                stringsAsFactors = FALSE)

pca_score_plot <- 
ggplot(x, aes(PC1, PC2, colour = GA)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point(size = 3) +
  scale_colour_gradientn(guide = guide_colorbar(title = "GA (week)"),
                         colours = c(
    alpha("royalblue", 1),
    alpha("royalblue", 0.3),
    alpha("red", 0.3),
    alpha("red", 1)
  )) +
  # scale_colour_brewer() +
  theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 12), 
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "#0099B47F"),
        strip.text = element_text(color = "white", size = 15))
ggsave(pca_score_plot, filename = "PCA_score_plot_batch1_RPLC_POS.pdf", 
       width = 8, height = 6)
pca_score_plot
```






#### RPLC pos batch 2

```{r, eval=TRUE, echo=TRUE}
library(metflow2)
library(ggplot2)
library(tidyverse)

sample.info <- 
  smartd_rplc_pos_batch2_5@sample.info

subject_data <- 
  getData(object = smartd_rplc_pos_batch2_5, slot = "Subject")

sample.info <- 
  sample.info %>% 
  filter(GA != 0)

subject_data <- 
  subject_data %>% 
  select(one_of(sample.info$sample.name))

##auto scale
subject_data <- 
  t(
    apply(subject_data, 1, function(x){
      (x - mean(x))/sd(x)
    })
  ) %>% 
  as_tibble()

subject_data2 <- t(subject_data)
subject_data2 <- as_tibble(subject_data2)
# rownames(subject_data2)

subject_data2 <- 
  subject_data2 %>% 
  mutate(GA = sample.info$GA)

##PCA analysis
pca_object <- 
  prcomp(x = select(subject_data2, -GA))

library(ggfortify)
x <- pca_object$x
x <- x[,1:2]
x <- 
  data.frame(x, GA = subject_data2$GA, stringsAsFactors = FALSE)
x <- data.frame(x, name = colnames(subject_data), 
                stringsAsFactors = FALSE)

pca_score_plot <- 
ggplot(x, aes(PC1, PC2, colour = GA)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point(size = 3) +
  scale_colour_gradientn(guide = guide_colorbar(title = "GA (week)"),
                         colours = c(
    alpha("royalblue", 1),
    alpha("royalblue", 0.3),
    alpha("red", 0.3),
    alpha("red", 1)
  )) +
  # scale_colour_brewer() +
  theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 12), 
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "#0099B47F"),
        strip.text = element_text(color = "white", size = 15))
ggsave(pca_score_plot, filename = "PCA_score_plot_batch2_RPLC_POS.pdf", 
       width = 8, height = 6)
pca_score_plot
```


#### RPLC neg batch 1

```{r, eval=TRUE, echo=TRUE}
sample.info <- 
  smartd_rplc_neg_batch1_5@sample.info

subject_data <- 
  getData(object = smartd_rplc_neg_batch1_5, slot = "Subject")

sample.info <- 
  sample.info %>% 
  filter(GA != 0)

subject_data <- 
  subject_data %>% 
  select(one_of(sample.info$sample.name))

subject_data <- 
  t(
    apply(subject_data, 1, function(x){
      (x - mean(x))/sd(x)
    })
  ) %>% 
  as_tibble()

subject_data2 <- t(subject_data)
subject_data2 <- as_tibble(subject_data2)

subject_data2 <- 
  subject_data2 %>% 
  mutate(GA = sample.info$GA)

##PCA analysis
pca_object <- 
  prcomp(x = select(subject_data2, -GA))

library(ggfortify)
x <- pca_object$x
x <- x[,1:2]
x <- 
  data.frame(x, GA = subject_data2$GA, stringsAsFactors = FALSE)
x <- data.frame(x, name = colnames(subject_data), 
                stringsAsFactors = FALSE)

pca_score_plot <- 
ggplot(x, aes(PC1, PC2, colour = GA)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point(size = 3) +
  scale_colour_gradientn(guide = guide_colorbar(title = "GA (week)"),
                         colours = c(
    alpha("royalblue", 1),
    alpha("royalblue", 0.3),
    alpha("red", 0.3),
    alpha("red", 1)
  )) +
  # scale_colour_brewer() +
  theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 12), 
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "#0099B47F"),
        strip.text = element_text(color = "white", size = 15))
ggsave(pca_score_plot, filename = "PCA_score_plot_batch1_RPLC_NEG.pdf", 
       width = 8, height = 6)
pca_score_plot
```

#### RPLC neg batch 2

```{r, eval=TRUE, echo=TRUE}
sample.info <- 
  smartd_rplc_neg_batch2_5@sample.info

subject_data <- 
  getData(object = smartd_rplc_neg_batch2_5, slot = "Subject")

sample.info <- 
  sample.info %>% 
  filter(GA != 0)

subject_data <- 
  subject_data %>% 
  select(one_of(sample.info$sample.name))

subject_data <- 
  t(
    apply(subject_data, 1, function(x){
      (x - mean(x))/sd(x)
    })
  ) %>% 
  as_tibble()

subject_data2 <- t(subject_data)
subject_data2 <- as_tibble(subject_data2)

subject_data2 <- 
  subject_data2 %>% 
  mutate(GA = sample.info$GA)

##PCA analysis
pca_object <- 
  prcomp(x = select(subject_data2, -GA))

library(ggfortify)
x <- pca_object$x
x <- x[,1:2]
x <- 
  data.frame(x, GA = subject_data2$GA, stringsAsFactors = FALSE)
x <- data.frame(x, name = colnames(subject_data), 
                stringsAsFactors = FALSE)

pca_score_plot <- 
ggplot(x, aes(PC1, PC2, colour = GA)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point(size = 3) +
  scale_colour_gradientn(guide = guide_colorbar(title = "GA (week)"),
                         colours = c(
    alpha("royalblue", 1),
    alpha("royalblue", 0.3),
    alpha("red", 0.3),
    alpha("red", 1)
  )) +
  # scale_colour_brewer() +
  theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 12), 
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "#0099B47F"),
        strip.text = element_text(color = "white", size = 15))
ggsave(pca_score_plot, filename = "PCA_score_plot_batch2_RPLC_NEG.pdf", 
       width = 8, height = 6)
pca_score_plot
```
 
We can see that there are several samples are outliers in PCA score plot, so we remove these samples and do PCA again.
 
```{r, eval=TRUE, echo=TRUE}
##remove some outliers
sample.info <- 
  sample.info %>% 
  filter(!sample.name %in% c("X65", "X82", "X68", "X66", "X75", "X67", "X85", "X62",
                             "X77", "X84", "X76", "X83", "X81", "X72", "X79", "X89",
                             "X89", "X78", "X70", "X71", "X80", "X73", "X74"))

subject_data <- 
  subject_data %>% 
  select(one_of(sample.info$sample.name))

subject_data <- 
  t(
    apply(subject_data, 1, function(x){
      (x - mean(x))/sd(x)
    })
  ) %>% 
  as_tibble()

subject_data2 <- t(subject_data)
subject_data2 <- as_tibble(subject_data2)
# rownames(subject_data2)

subject_data2 <- 
  subject_data2 %>% 
  mutate(GA = sample.info$GA)

##PCA analysis
pca_object <- 
  prcomp(x = select(subject_data2, -GA))

library(ggfortify)
x <- pca_object$x
x <- x[,1:2]
x <- 
  data.frame(x, GA = subject_data2$GA, stringsAsFactors = FALSE)
x <- data.frame(x, name = colnames(subject_data), 
                stringsAsFactors = FALSE)

pca_score_plot <- 
ggplot(x, aes(PC1, PC2, colour = GA)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point(size = 3) +
  scale_colour_gradientn(guide = guide_colorbar(title = "GA (week)"),
                         colours = c(
    alpha("royalblue", 1),
    alpha("royalblue", 0.3),
    alpha("red", 0.3),
    alpha("red", 1)
  )) +
  # scale_colour_brewer() +
  theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 12), 
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "#0099B47F"),
        strip.text = element_text(color = "white", size = 15))
ggsave(pca_score_plot, filename = "PCA_score_plot_batch2_RPLC_NEG_remove_outliers.pdf", 
       width = 8, height = 6)
pca_score_plot
```



### Patient information

All the patient information are in 'E:/project/smartD/data_analysis20190828/patient_info'

```{r message=FALSE, warning=FALSE}
##This is the file contains all the information of all the samples
all346_urine_info <- 
  readr::read_csv("E:/project/smartD/data_analysis20190828/patient_info/SmartD_all346urine.csv")

##PTID is the ID of patients
all346_urine_info %>% 
  group_by(PTID) %>% 
  summarise(n = n())
dim(all346_urine_info)

##Ther are 36 patients and 346 samples in total. 

all346_urine_info %>% 
  group_by(PTID) %>% 
  summarise(n = n()) %>% 
  arrange(n) %>% 
  mutate(PTID = factor(PTID, levels = PTID)) %>% 
  ggplot(.,aes(x = PTID, y = n)) +
  geom_point(colour = "red") +
  geom_segment(aes(x = 1:36, y = 0, xend = 1:36, yend = n), colour = "grey") +
  coord_flip() +
  labs(x = "Patient ID", y = "Sample number") +
  theme_bw() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())
```

You can see that different people have different number of samples. Now we want to get the distribution of sample collection.

```{r message=FALSE, warning=FALSE}
temp_data <- 
  all346_urine_info %>% 
  select(PTID, Visit.GA)

plot1 <- 
ggplot(temp_data, aes(x = Visit.GA, y = PTID)) +
  geom_point() +
  theme_bw() +
    scale_x_continuous(limits = c(10, 43))

plot2 <-
ggplot(temp_data, aes(x = Visit.GA)) +
  geom_bar(binwidth = 0.5) +
  theme_bw() +
  scale_x_continuous(limits = c(10, 43), 
                     name = NULL, labels = NULL, breaks = NULL) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .05))) +
  theme(panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
  

plot3 <- 
ggplot(temp_data, aes(x = PTID)) +
  geom_bar(width = 0.8) +
  theme_bw() +
  scale_x_discrete(name = NULL, label = NULL, breaks = NULL) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .05))) +
  coord_flip() +
  theme(panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

library(patchwork)

plot <- 
{plot2 + plot_spacer() + plot_layout(ncol = 2, widths = c(3, 1))} -
  {plot1 + plot3 + plot_layout(ncol = 2, widths = c(3, 1))} +
  plot_layout(ncol = 1, heights = c(1,3))

ggsave(plot, 
       filename = "Sample_colection_distribution.pdf", 
       width = 8, height = 6)

plot
```

Batch 1 as discovery dataset and batch 2 as validation dataset

So we should get the demographics characterisitics of discovery and validation datasets.

```{r}
##This is the file contains all the information of all the samples
all346_urine_info <- 
  readr::read_csv("E:/project/smartD/data_analysis20190828/patient_info/SmartD_all346urine.csv")

patient_info <- readr::read_csv("E:/project/smartD/data_analysis20190828/patient_info/patient_info.csv")

all346_urine_info <- 
  all346_urine_info %>% 
  rename("Patient_ID" = PTID, "Smple_ID" = sample_id_RPLC)
```

Let me check if all the samples are in the patient information files.

```{r}
colnames(getData(object = smartd_rplc_pos_batch1_5, slot = "Subject"))

colnames(getData(object = smartd_rplc_pos_batch2_5, slot = "Subject"))

```




$$Q = \frac{1}{2*m} \sum(\frac{A_{ij}-k_i*k_j}{2*m})\delta(c_i, c_j)$$
